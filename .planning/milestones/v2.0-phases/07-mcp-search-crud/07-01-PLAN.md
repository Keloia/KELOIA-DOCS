---
phase: 07-mcp-search-crud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp-server/src/tools/docs.ts
  - mcp-server/src/server.ts
autonomous: true
requirements:
  - SRCH-05
  - SRCH-06
  - CRUD-06
  - CRUD-07
  - CRUD-08

must_haves:
  truths:
    - "keloia_search_docs returns matching docs with slug, title, snippet, and lineNumber for a keyword query"
    - "keloia_search_docs returns matching docs for a regex pattern"
    - "keloia_search_docs with a slug filter narrows results to that single doc"
    - "keloia_search_docs with an invalid slug returns isError"
    - "keloia_add_doc creates a new .md file in data/docs/ and adds the slug to index.json"
    - "keloia_add_doc fails with isError if slug already exists in index or on disk"
    - "keloia_edit_doc overwrites an existing doc file content"
    - "keloia_edit_doc fails with isError if slug does not exist"
    - "keloia_delete_doc removes the slug from index.json before deleting the file"
    - "keloia_delete_doc fails with isError if slug does not exist"
  artifacts:
    - path: "mcp-server/src/tools/docs.ts"
      provides: "keloia_search_docs, keloia_add_doc, keloia_edit_doc, keloia_delete_doc tool registrations"
      exports: ["registerDocTools"]
    - path: "mcp-server/src/server.ts"
      provides: "Updated server with doc tools registration"
      contains: "registerDocTools"
  key_links:
    - from: "mcp-server/src/tools/docs.ts"
      to: "mcp-server/src/paths.ts"
      via: "DOCS_DIR import"
      pattern: "import.*DOCS_DIR.*paths"
    - from: "mcp-server/src/server.ts"
      to: "mcp-server/src/tools/docs.ts"
      via: "registerDocTools import and call"
      pattern: "registerDocTools\\(server\\)"
    - from: "mcp-server/src/tools/docs.ts"
      to: "data/docs/index.json"
      via: "readFileSync + atomicWriteJson for CRUD operations"
      pattern: "readFileSync.*index\\.json"
---

<objective>
Implement all five Phase 7 MCP tools — `keloia_search_docs` (keyword + regex search with optional slug filter), `keloia_add_doc`, `keloia_edit_doc`, `keloia_delete_doc` — in a new `docs.ts` module and register them in the MCP server.

Purpose: Give Claude Code the ability to search documentation content by keyword or regex and create/edit/delete doc files directly via MCP tools, completing the doc-surface write capabilities.

Output: `mcp-server/src/tools/docs.ts` with all five tools, updated `server.ts` registration, compiled `dist/` output.
</objective>

<execution_context>
@/Users/enjat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enjat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-mcp-search-crud/07-RESEARCH.md
@mcp-server/src/tools/write.ts
@mcp-server/src/tools/read.ts
@mcp-server/src/server.ts
@mcp-server/src/paths.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docs.ts with all five MCP doc tools</name>
  <files>mcp-server/src/tools/docs.ts</files>
  <action>
Create `mcp-server/src/tools/docs.ts` exporting `registerDocTools(server: McpServer): void`. Follow the exact patterns from `write.ts` (atomicWriteJson, isError shape, try/catch, `type: "text" as const`).

**Module-level helpers:**

1. `atomicWriteText(targetPath, text)` — parallel to `atomicWriteJson` in write.ts: `writeFileSync(tmp, text, "utf-8")` then `renameSync(tmp, targetPath)`.
2. `atomicWriteJson(targetPath, data)` — same pattern as write.ts (write tmp + rename). Duplicate it locally rather than importing from write.ts to keep modules independent.
3. `SLUG_RE = /^[a-z0-9][a-z0-9-]*[a-z0-9]$|^[a-z0-9]$/` — slug format validation regex.

**Imports:** `readFileSync, writeFileSync, renameSync, unlinkSync, existsSync` from `node:fs`, `join` from `node:path`, `z` from `zod`, `McpServer` type from SDK, `DOCS_DIR` from `../paths.js`.

**Tool 1: `keloia_search_docs`** (SRCH-05, SRCH-06)
- Description: "Searches keloia documentation files by keyword or regex pattern. Returns matching lines with slug, title, line number, and a text snippet. Use the optional slug parameter to narrow results to a single doc."
- inputSchema: `pattern: z.string().min(1)`, `slug: z.string().optional()`, `is_regex: z.boolean().optional().default(false)`
- Implementation: Read `index.json`, filter by slug if provided (return `isError` if slug not found in index), compile regex if `is_regex` (try/catch for invalid regex → `isError`), iterate docs line-by-line, case-insensitive `indexOf` for keyword or `exec()` with `lastIndex = 0` reset for regex, extract 150-char snippet centered on match, cap at 50 results, return JSON array of `{ slug, title, lineNumber, snippet }`.
- **Critical:** Reset `compiled.lastIndex = 0` before every `exec()` call to prevent match skipping across lines.

**Tool 2: `keloia_add_doc`** (CRUD-06)
- Description: "Creates a new markdown documentation file in data/docs/ and registers it in the doc index. Fails if the slug already exists. Do NOT use this to update an existing doc — use keloia_edit_doc instead."
- inputSchema: `slug: z.string().min(1)`, `title: z.string().min(1)`, `content: z.string().min(1)`
- Implementation: Validate slug with `SLUG_RE` (→ `isError` if invalid), read index, check slug NOT in index (→ `isError`), check `existsSync` on disk (→ `isError` per Pitfall 3 — mcp-guide.md collision), `atomicWriteText` the .md file, `atomicWriteJson` the index with slug+title appended.

**Tool 3: `keloia_edit_doc`** (CRUD-07)
- Description: "Overwrites an existing keloia documentation file. Optionally updates the document title in the index. Fails if the slug does not exist. Do NOT use this to create a new doc — use keloia_add_doc instead."
- inputSchema: `slug: z.string().min(1)`, `content: z.string().min(1)`, `title: z.string().optional()`
- Implementation: Read index, check slug IS in index (→ `isError`), `atomicWriteText` the .md file. If `title` provided, update the matching entry in index.docs and `atomicWriteJson` the index.

**Tool 4: `keloia_delete_doc`** (CRUD-08)
- Description: "Removes an existing keloia documentation file and deregisters it from the doc index. Fails if the slug does not exist. This operation is irreversible."
- inputSchema: `slug: z.string().min(1)`
- Implementation: Read index, check slug IS in index (→ `isError`). **Update index FIRST** (filter out slug, atomicWriteJson), THEN `unlinkSync` the file. This ordering is per success criterion #5.

All tools return `{ content: [{ type: "text" as const, text: JSON.stringify(result, null, 2) }] }` on success and `{ isError: true, content: [{ type: "text" as const, text: errorMessage }] }` on failure, matching existing tool patterns.
  </action>
  <verify>
Run `npx tsc --noEmit` in `mcp-server/` — zero type errors. Visually confirm all five tools are registered inside `registerDocTools`.
  </verify>
  <done>
`docs.ts` exists with `registerDocTools` exporting five tool registrations: `keloia_search_docs`, `keloia_add_doc`, `keloia_edit_doc`, `keloia_delete_doc`. All use atomic write patterns, slug validation, and isError error handling matching existing tool conventions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register doc tools in server.ts, build, and verify</name>
  <files>mcp-server/src/server.ts</files>
  <action>
1. **Update `server.ts`:** Add `import { registerDocTools } from "./tools/docs.js";` alongside existing imports. Add `registerDocTools(server);` after `registerWriteTools(server);` inside `createServer()`.

2. **Build:** Run `npm run build` in `mcp-server/` to compile TypeScript to `dist/`.

3. **Verify build:** Confirm `mcp-server/dist/tools/docs.js` exists and contains all five tool names as string literals.

4. **Verify tool count:** Run the built server briefly to confirm no import errors: `cd mcp-server && node -e "import('./dist/index.js')" 2>&1 | head -5` — should not show "Cannot find module" errors.
  </action>
  <verify>
`npm run build` in `mcp-server/` exits 0. `mcp-server/dist/tools/docs.js` exists. `grep -c "keloia_" mcp-server/dist/tools/docs.js` returns 4 or more (tool name occurrences).
  </verify>
  <done>
`server.ts` imports and calls `registerDocTools`. Build succeeds. `dist/tools/docs.js` compiled. All 11 keloia_ MCP tools (4 read + 3 write + 4 doc) are registered on the server.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` in `mcp-server/` completes without errors
2. `mcp-server/dist/tools/docs.js` exists and contains all four tool registration strings
3. `mcp-server/src/server.ts` imports and calls `registerDocTools`
4. Type check (`npx tsc --noEmit` in `mcp-server/`) passes with zero errors
</verification>

<success_criteria>
- Five new MCP tools are registered: keloia_search_docs, keloia_add_doc, keloia_edit_doc, keloia_delete_doc
- Search supports keyword (case-insensitive indexOf) and regex (with lastIndex reset) modes
- Search supports optional slug filter with isError on unknown slug
- add_doc validates slug format, checks index AND filesystem for duplicates
- edit_doc supports optional title update alongside content overwrite
- delete_doc updates index before file deletion (per success criterion #5)
- All tools follow existing patterns: atomicWrite, isError, try/catch, type: "text" as const
- Build compiles cleanly to dist/
</success_criteria>

<output>
After completion, create `.planning/phases/07-mcp-search-crud/07-01-SUMMARY.md`
</output>
