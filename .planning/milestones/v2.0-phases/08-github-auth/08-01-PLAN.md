---
phase: 08-github-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - style.css
  - app.js
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04

must_haves:
  truths:
    - "A login area in the sidebar lets the user paste a GitHub PAT and click Login"
    - "After entering a valid PAT, the sidebar shows a Logout button instead of the login form"
    - "After entering an invalid PAT, an error message appears and no token is stored"
    - "Closing the browser tab and reopening it keeps the user authenticated (token persists in localStorage)"
    - "Clicking Logout clears the token, hides write controls, and shows the login form again"
    - "Elements with class auth-only are hidden when unauthenticated and visible when authenticated"
  artifacts:
    - path: "index.html"
      provides: "Auth section in sidebar with login form (unauth-only) and logout button (auth-only)"
      contains: "id=\"auth-section\""
    - path: "style.css"
      provides: "CSS visibility rules for .auth-only and .unauth-only classes, auth form styling"
      contains: ".auth-only"
    - path: "app.js"
      provides: "Auth module: verifyToken, setAuthState, initAuth, login/logout handlers, getAuthToken accessor"
      contains: "verifyToken"
  key_links:
    - from: "app.js (login handler)"
      to: "https://api.github.com/user"
      via: "fetch with Bearer token"
      pattern: "fetch.*api\\.github\\.com/user"
    - from: "app.js (setAuthState)"
      to: "document.body.classList"
      via: "add/remove 'authenticated' class"
      pattern: "classList\\.(add|remove).*authenticated"
    - from: "app.js (initAuth)"
      to: "localStorage"
      via: "getItem/setItem/removeItem with keloia_gh_token key"
      pattern: "localStorage\\.(get|set|remove)Item.*keloia_gh_token"
---

<objective>
Add GitHub PAT authentication to the site — a sidebar login form, token verification via the GitHub `/user` API, localStorage persistence, and CSS-driven auth gating for future write controls.

Purpose: Phase 8 unlocks write UI for Phases 10–11. Without auth gating, edit/add/delete/drag controls would be visible to unauthenticated visitors.
Output: Auth section in sidebar, auth state management in app.js, CSS visibility rules for .auth-only / .unauth-only classes.
</objective>

<execution_context>
@/Users/enjat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enjat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-github-auth/08-RESEARCH.md
@index.html
@style.css
@app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auth HTML section and CSS visibility rules</name>
  <files>index.html, style.css</files>
  <action>
**index.html** — Add an auth section at the bottom of the `<nav id="sidebar">`, after the Resources section and before the closing `</nav>` tag:

```html
<section class="nav-section" id="auth-section">
  <div class="unauth-only">
    <input
      type="password"
      id="token-input"
      class="token-input"
      placeholder="GitHub PAT..."
      autocomplete="off"
    />
    <button id="login-btn" class="btn-auth">Login</button>
    <p id="login-error" class="login-error" hidden></p>
  </div>
  <div class="auth-only">
    <button id="logout-btn" class="btn-auth btn-logout">Logout</button>
  </div>
</section>
```

**style.css** — Add an "Authentication" section after the Search Results section (before any media queries or at end of main styles). Include:

1. **Auth gating classes:**
   - `.auth-only { display: none; }` — hidden by default
   - `body.authenticated .auth-only { display: block; }` — revealed when authenticated
   - `body.authenticated .unauth-only { display: none; }` — login form hidden when authenticated

2. **Auth UI styling:**
   - `.token-input` — full-width input matching `.search-input` styling (same background, border, color, padding, border-radius). Use `width: 100%;` and `margin-bottom: 8px;`.
   - `.btn-auth` — full-width button, background `var(--accent)`, white text, no border, padding `8px 12px`, border-radius `4px`, cursor pointer. Hover: slight opacity reduction (0.85).
   - `.btn-auth:disabled` — opacity 0.5, cursor not-allowed (for "Verifying..." state).
   - `.btn-logout` — different background: `var(--col-backlog)` (gray tone) or `#555` to visually distinguish from login.
   - `.login-error` — color `#ff6b6b`, font-size `0.8rem`, margin-top `6px`.

Keep the auth section compact — this sits at the bottom of the sidebar and should not crowd the navigation.
  </action>
  <verify>
Open index.html in a browser. Confirm:
1. The auth section appears at the bottom of the sidebar with a password input and Login button.
2. No Logout button is visible (it has class auth-only, which is display:none by default).
3. Manually adding `class="authenticated"` to `<body>` in DevTools hides the login form and shows the Logout button.
  </verify>
  <done>Auth HTML section exists in sidebar with login form (unauth-only) and logout button (auth-only). CSS rules hide/show elements based on body.authenticated class. Styles are consistent with existing dark theme.</done>
</task>

<task type="auto">
  <name>Task 2: Implement auth logic in app.js</name>
  <files>app.js</files>
  <action>
Add an "Authentication" section in app.js between the "Utility" section and the "Site Search" section (line ~228). This keeps auth state available to search and router code.

**Constants and state:**
```javascript
const TOKEN_KEY = 'keloia_gh_token';
let currentToken = null;
```

**verifyToken(token)** — async function. Calls `fetch('https://api.github.com/user', { headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github+json' } })`. Returns `res.ok` (true on 200, false on 401/403). Wrap in try/catch, return false on network error. Do NOT include `X-GitHub-Api-Version` header (potential CORS preflight issue per research).

**setAuthState(token)** — sets `currentToken = token`. If token is truthy, `document.body.classList.add('authenticated')`. If falsy, `document.body.classList.remove('authenticated')`.

**getAuthToken()** — returns `currentToken`. This accessor will be used by Phase 9 (GitHub API wrapper) to get the token for API calls.

**initAuth()** — async function. Reads `localStorage.getItem(TOKEN_KEY)`. If a stored token exists, calls `verifyToken(stored)`. If valid, calls `setAuthState(stored)`. If invalid (token revoked/expired), calls `localStorage.removeItem(TOKEN_KEY)` and `setAuthState(null)`. If no stored token, does nothing (page stays in unauthenticated state).

**Login handler** — In the Bootstrap section, after the search event listeners block, add:

```javascript
const loginBtn = document.getElementById('login-btn');
const tokenInput = document.getElementById('token-input');
const loginError = document.getElementById('login-error');

if (loginBtn) {
  loginBtn.addEventListener('click', async () => {
    const token = tokenInput.value.trim();
    if (!token) return;

    // Disable button, show verifying state
    loginBtn.disabled = true;
    loginBtn.textContent = 'Verifying...';
    loginError.hidden = true;

    const valid = await verifyToken(token);

    if (valid) {
      localStorage.setItem(TOKEN_KEY, token);
      setAuthState(token);
      tokenInput.value = '';
    } else {
      loginError.textContent = 'Invalid token. Check and try again.';
      loginError.hidden = false;
    }

    loginBtn.disabled = false;
    loginBtn.textContent = 'Login';
  });
}
```

Also support Enter key on the token input — add a `keydown` listener on `tokenInput` that clicks `loginBtn` when key is 'Enter'.

**Logout handler:**
```javascript
const logoutBtn = document.getElementById('logout-btn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem(TOKEN_KEY);
    setAuthState(null);
  });
}
```

**Bootstrap integration** — In the DOMContentLoaded handler, call `initAuth()` WITHOUT awaiting it (non-blocking, per research recommendation — auth state is sidebar-only in Phase 8, so brief flash has no visible effect since auth-only elements are hidden by default CSS). Place the `initAuth()` call after `populateDocList()` and before `router()`:

```javascript
window.addEventListener('DOMContentLoaded', async () => {
  await populateDocList();
  initAuth(); // non-blocking — verifies stored token in background
  await router();
  // ... existing search listeners ...
  // ... login/logout handlers ...
});
```

**IMPORTANT:** Do NOT await `initAuth()` — it runs in background. The page renders immediately. When verification completes, `setAuthState` toggles the body class and the CSS handles visibility.
  </action>
  <verify>
1. Open the site in a browser with DevTools console open.
2. Enter an invalid token string in the PAT input → click Login → confirm "Invalid token" error appears, no localStorage entry created.
3. Enter a valid GitHub PAT → click Login → confirm: login form disappears, Logout button appears, `localStorage.getItem('keloia_gh_token')` returns the token in DevTools console.
4. Refresh the page → confirm Logout button still visible (token persisted and re-verified).
5. Click Logout → confirm: login form reappears, `localStorage.getItem('keloia_gh_token')` returns null.
6. In console, confirm `getAuthToken()` returns the token when authenticated and null when not.
  </verify>
  <done>verifyToken calls GitHub /user API with Bearer header. setAuthState toggles body.authenticated class. initAuth restores and re-verifies stored token on page load. Login handler verifies before storing. Logout handler clears token and resets state. getAuthToken accessor available for Phase 9. Enter key triggers login. Button shows "Verifying..." during API call.</done>
</task>

</tasks>

<verification>
1. Open site → login form visible in sidebar, no Logout button
2. Enter invalid PAT → error shown, no token in localStorage
3. Enter valid PAT → form swaps to Logout button, token in localStorage
4. Refresh page → still authenticated (re-verification of stored token)
5. Click Logout → form returns, token cleared
6. DevTools: `document.body.classList.contains('authenticated')` matches expected state
7. DevTools: `getAuthToken()` returns token or null correctly
8. Add `class="auth-only"` to any test element → hidden when logged out, visible when logged in
</verification>

<success_criteria>
- AUTH-01: PAT input + Login button in sidebar; verified against GitHub /user API before acceptance
- AUTH-02: Token persists in localStorage under 'keloia_gh_token'; survives tab close/reopen
- AUTH-03: Logout button clears localStorage and removes authenticated class from body
- AUTH-04: .auth-only elements hidden by default CSS; visible only when body.authenticated is present
</success_criteria>

<output>
After completion, create `.planning/phases/08-github-auth/08-01-SUMMARY.md`
</output>
