---
phase: 09-github-api-wrapper
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - github.js
  - index.html
autonomous: true
requirements: [CRUD-05]

must_haves:
  truths:
    - "Writing the same file twice in rapid succession completes without a 409 Conflict error"
    - "Saving content containing non-ASCII characters (em dash, smart quotes) completes without an InvalidCharacterError"
    - "Decoding a file fetched from the GitHub API succeeds without whitespace errors"
    - "Every update and delete fetches the current file SHA immediately before the write — no cached SHAs"
    - "getFile, writeFile, and deleteFile are callable from the browser console"
  artifacts:
    - path: "github.js"
      provides: "GitHub Contents API wrapper with serialized write queue"
      contains: "encodeToBase64"
    - path: "github.js"
      provides: "Unicode-safe Base64 encode/decode"
      contains: "TextEncoder"
    - path: "github.js"
      provides: "Serialized write queue"
      contains: "enqueueWrite"
    - path: "index.html"
      provides: "github.js script tag loaded before app.js"
      contains: "github.js"
  key_links:
    - from: "github.js"
      to: "app.js"
      via: "getAuthToken() call for Bearer token"
      pattern: "getAuthToken\\(\\)"
    - from: "github.js"
      to: "https://api.github.com/repos/Keloia/KELOIA-DOCS/contents"
      via: "fetch calls to GitHub Contents API"
      pattern: "api\\.github\\.com"
    - from: "index.html"
      to: "github.js"
      via: "script tag before app.js"
      pattern: "src=\"github.js\""
---

<objective>
Create the GitHub Contents API wrapper module (`github.js`) that Phase 10 and Phase 11 will use for all site write operations.

Purpose: Provide a safe, serialized, Unicode-aware interface to the GitHub Contents API so that downstream phases never deal with SHA management, Base64 encoding, or write concurrency directly.

Output: `github.js` with `getFile`, `writeFile`, and `deleteFile` functions; `index.html` updated with script tag.
</objective>

<execution_context>
@/Users/enjat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enjat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-github-api-wrapper/09-RESEARCH.md
@.planning/phases/08-github-auth/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create github.js module with Contents API wrapper</name>
  <files>github.js</files>
  <action>
Create `github.js` in the project root (alongside `app.js`). This is a new file.

The module must contain these components in order:

1. **Constants:** `OWNER = 'Keloia'`, `REPO = 'KELOIA-DOCS'`, `API` template string for `https://api.github.com/repos/${OWNER}/${REPO}/contents`.

2. **Write queue:** Module-level `let writeQueue = Promise.resolve()` and `enqueueWrite(fn)` function. The queue tail assignment must use `result.catch(() => {})` so a failed write does not block subsequent operations. Return `result` (not the caught version) to the caller so they see the rejection.

3. **Unicode-safe Base64 helpers:**
   - `encodeToBase64(str)`: `TextEncoder().encode(str)` → `Array.from(bytes, b => String.fromCodePoint(b)).join('')` → `btoa(binString)`. Never call `btoa()` directly on raw strings.
   - `decodeFromBase64(base64)`: Strip whitespace with `.replace(/\s/g, '')` FIRST, then `atob(clean)` → `Uint8Array.from(binString, c => c.codePointAt(0))` → `new TextDecoder().decode(bytes)`. The whitespace strip is required because GitHub wraps Base64 at 76 characters with newlines.

4. **`authHeaders()` helper:** Calls `getAuthToken()` (Phase 8 global function from app.js). If token is falsy, throw `new Error('Not authenticated')`. Returns object with `Authorization: 'Bearer ' + token` and `Accept: 'application/vnd.github+json'`. Do NOT include `X-GitHub-Api-Version` header — it is not in the CORS allow list and will cause preflight failures.

5. **`getFile(path)`:** GET request to `${API}/${path}` with `authHeaders()`. Return `null` on 404. Throw on other non-ok responses. On success, return `{ sha: data.sha, content: decodeFromBase64(data.content) }`. This function is NOT queued — reads are safe to run concurrently.

6. **`_writeFileImpl(path, content, commitMessage)`:** (Private, not exposed globally.) Call `getFile(path)` to check existence. Build body with `message`, `content: encodeToBase64(content)`. If file exists, add `sha: existing.sha`. PUT to `${API}/${path}` with `authHeaders()` plus `Content-Type: application/json`. Throw on non-ok. Return `res.json()`.

7. **`_deleteFileImpl(path, commitMessage)`:** (Private, not exposed globally.) Call `getFile(path)` for fresh SHA. If null, throw `Cannot delete ${path}: file not found`. DELETE to `${API}/${path}` with body `{ message, sha: existing.sha }`. Include `Content-Type: application/json`. Throw on non-ok. Return `res.json()`.

8. **Public API (3 functions exposed as globals for Phase 10/11):**
   - `writeFile(path, content, commitMessage)` → `enqueueWrite(() => _writeFileImpl(...))`
   - `deleteFile(path, commitMessage)` → `enqueueWrite(() => _deleteFileImpl(...))`
   - `getFile(path)` — already defined above, directly callable

Since this is a vanilla JS project with no module bundler (all scripts loaded via `<script>` tags), the functions `getFile`, `writeFile`, and `deleteFile` must be accessible as global functions. Use plain `function` declarations or assign to `window` explicitly for the public API.

Target: ~80 lines of code. No npm dependencies. No imports. Pure browser APIs (`fetch`, `TextEncoder`, `TextDecoder`, `btoa`, `atob`).
  </action>
  <verify>
Open `github.js` and confirm:
1. `encodeToBase64` uses TextEncoder (not raw btoa)
2. `decodeFromBase64` strips whitespace before atob
3. `authHeaders()` calls `getAuthToken()` and throws if null
4. `authHeaders()` does NOT include X-GitHub-Api-Version
5. `_writeFileImpl` calls `getFile` for fresh SHA before every PUT
6. `_deleteFileImpl` calls `getFile` for fresh SHA before every DELETE
7. `enqueueWrite` uses `result.catch(() => {})` for queue tail
8. `writeFile` and `deleteFile` both go through `enqueueWrite`
9. `getFile`, `writeFile`, `deleteFile` are accessible as globals
  </verify>
  <done>github.js exists in project root with getFile, writeFile, deleteFile as global functions; uses serialized write queue, Unicode-safe Base64, and fresh-SHA-before-every-write pattern</done>
</task>

<task type="auto">
  <name>Task 2: Add github.js script tag to index.html</name>
  <files>index.html</files>
  <action>
In `index.html`, add a `<script src="github.js"></script>` tag. It must be placed AFTER the `app.js` script tag (not before), because `github.js` calls `getAuthToken()` which is defined in `app.js`. Since `app.js` uses `defer`, it will execute in document order — but `github.js` does not need `defer` because it only defines functions and a promise variable (no DOM access at load time). However, to ensure `getAuthToken` is defined before `github.js` functions are called, add `defer` to `github.js` as well so both scripts execute in order after parsing.

The line to add (immediately after the `app.js` script tag):
```html
<script src="github.js" defer></script>
```

This follows the existing CDN ordering pattern: marked -> DOMPurify -> MiniSearch -> app.js -> github.js.
  </action>
  <verify>
Open `index.html` in a browser. Open DevTools console. Confirm:
1. No script loading errors in console
2. `typeof writeFile` returns `'function'`
3. `typeof deleteFile` returns `'function'`
4. `typeof getFile` returns `'function'`
  </verify>
  <done>index.html loads github.js after app.js; all three public API functions (getFile, writeFile, deleteFile) are available as globals in the browser</done>
</task>

</tasks>

<verification>
After both tasks are complete, verify the full integration:

1. **Script loading:** Open `index.html` in browser, confirm no console errors
2. **Global availability:** In console, `typeof getFile === 'function'` and `typeof writeFile === 'function'` and `typeof deleteFile === 'function'`
3. **Auth guard:** Without logging in, `getFile('data/docs/index.json')` should reject with "Not authenticated"
4. **Unicode Base64 round-trip:** In console: `decodeFromBase64(encodeToBase64('em dash — smart "quotes"'))` should return the original string
5. **Whitespace stripping:** `decodeFromBase64('SGVsbG8g\nd29ybGQ=')` should return `'Hello world'` without throwing
</verification>

<success_criteria>
- github.js exists with ~80 lines, zero dependencies
- Three public functions: getFile, writeFile, deleteFile
- Write queue serializes all writes (no concurrent PUT/DELETE possible)
- Unicode-safe Base64 via TextEncoder/TextDecoder pipeline
- Fresh SHA fetched before every update and delete (no caching)
- No X-GitHub-Api-Version header in any request
- index.html loads github.js after app.js
- Phase 10/11 can call `writeFile('data/docs/slug.md', content, 'docs: update slug')` without knowing about SHA, Base64, or concurrency
</success_criteria>

<output>
After completion, create `.planning/phases/09-github-api-wrapper/09-01-SUMMARY.md`
</output>
