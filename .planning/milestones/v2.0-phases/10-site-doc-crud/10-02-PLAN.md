---
phase: 10-site-doc-crud
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified: [app.js, style.css, index.html]
autonomous: true
requirements: [CRUD-01, CRUD-04]

must_haves:
  truths:
    - "Authenticated user can create a new doc by entering a slug, title, and markdown body — the doc appears in the sidebar after creation"
    - "Authenticated user can delete a doc via a confirmation modal that names the doc title — the doc is removed from the sidebar after deletion"
    - "Slug validation prevents invalid characters and duplicate slugs"
    - "A 'New Doc' button is visible in the sidebar only when authenticated"
  artifacts:
    - path: "app.js"
      provides: "renderCreateView, showDeleteModal, index.json helpers"
      contains: "renderCreateView"
    - path: "app.js"
      provides: "showDeleteModal with confirmation and delete flow"
      contains: "showDeleteModal"
    - path: "style.css"
      provides: "Create form and modal overlay CSS"
      contains: "modal-overlay"
    - path: "index.html"
      provides: "New Doc button in sidebar Docs section"
      contains: "new-doc-btn"
  key_links:
    - from: "app.js renderCreateView create-btn"
      to: "writeFile('data/docs/slug.md') + writeFile('data/docs/index.json')"
      via: "GitHub API wrapper for file creation and index update"
      pattern: "writeFile\\(.*index\\.json"
    - from: "app.js showDeleteModal confirm-delete-btn"
      to: "deleteFile('data/docs/slug.md') + writeFile('data/docs/index.json')"
      via: "GitHub API wrapper for file deletion and index update"
      pattern: "deleteFile\\("
    - from: "app.js create/delete handlers"
      to: "populateDocList()"
      via: "sidebar refresh after CRUD operation"
      pattern: "populateDocList\\(\\)"
---

<objective>
Wire the create and delete UI for docs: implement `renderCreateView()` with slug validation and index.json update, replace the `showDeleteModal` stub with a real confirmation modal and delete flow, and add a "New Doc" button to the sidebar.

Purpose: CRUD-01 (create doc) and CRUD-04 (delete doc with confirmation) complete the full doc authoring cycle — users can add new docs and remove old ones directly from the site.

Output: Modified `app.js` with create/delete logic, modified `style.css` with form/modal styles, modified `index.html` with New Doc sidebar button.
</objective>

<execution_context>
@/Users/enjat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enjat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-site-doc-crud/10-RESEARCH.md
@.planning/phases/10-site-doc-crud/10-01-SUMMARY.md
@app.js
@style.css
@index.html
@github.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement renderCreateView, showDeleteModal, and New Doc sidebar button</name>
  <files>app.js, index.html</files>
  <action>
Three changes:

**1. Add "New Doc" button to index.html sidebar.**

In index.html, modify the Docs nav-section title row to include a New Doc button:

```html
<section class="nav-section">
  <div class="nav-section-header">
    <h3 class="nav-section-title">Docs</h3>
    <button class="btn-icon auth-only" id="new-doc-btn" title="New Doc">+</button>
  </div>
  <ul id="doc-list"></ul>
</section>
```

Wrap the `<h3>` and button in a `.nav-section-header` div for flex layout.

**2. Implement `renderCreateView()` in app.js.**

Add in the `/* === Doc Edit View === */` section (or create a `/* === Doc Create View === */` subsection). Implementation:

- Set `mainEl.innerHTML` to a create-view shell: heading "New Doc", form fields for slug (text input, `id="new-slug"`, placeholder "my-doc-name", with hint "Lowercase letters, numbers, hyphens only"), title (text input, `id="new-title"`, placeholder "My Doc Name"), content (textarea, `id="new-body"`, class `edit-textarea`, with a preview toggle button `id="new-preview-btn"` and hidden preview div `id="new-preview"`), an error paragraph (`id="create-error"`, hidden), and action buttons (Create Doc `id="create-btn"` class `btn-action`, Cancel `id="create-cancel-btn"` class `btn-action btn-secondary`).
- Wire the preview toggle on the body textarea (same pattern as edit view — toggle visibility of textarea vs preview div, render with `marked.parse` + `DOMPurify.sanitize`).
- Wire Cancel: `window.location.hash = '#/docs';`
- Wire Create Doc button click:
  1. Read slug, title, body values. Trim all.
  2. Validate slug: must match `/^[a-z0-9]+(-[a-z0-9]+)*$/` (lowercase alphanumeric with hyphens, no leading/trailing hyphens). If invalid, show error "Slug must be lowercase letters, numbers, and hyphens only."
  3. Validate title is not empty. If empty, show error "Title is required."
  4. Validate body is not empty. If empty, show error "Content is required."
  5. Fetch current index.json: `const indexFile = await getFile('data/docs/index.json');` then `const indexData = JSON.parse(indexFile.content);`. Check if slug already exists in `indexData.docs`: `if (indexData.docs.some(d => d.slug === slug))` — show error "A doc with this slug already exists."
  6. Disable button, change text to "Creating..."
  7. Write the markdown file FIRST: `await writeFile('data/docs/' + slug + '.md', body, 'docs: create ' + slug);`
  8. Then update the index: `indexData.docs.push({ slug, title }); await writeFile('data/docs/index.json', JSON.stringify(indexData, null, 2), 'docs: add ' + slug);`
  9. Refresh sidebar: `await populateDocList();`
  10. Navigate: `window.location.hash = '#/docs/' + slug;`
  11. On error: re-enable button, show error message.

- Wire New Doc button: Add in the DOMContentLoaded bootstrap block:
```javascript
document.getElementById('new-doc-btn').addEventListener('click', () => {
  window.location.hash = '#/docs/new';
});
```

**3. Replace showDeleteModal stub with full implementation.**

Replace the stub `showDeleteModal` function with the real implementation:

- Remove any existing modal: `document.getElementById('delete-modal')?.remove();`
- Create an overlay div (`id="delete-modal"`, class `modal-overlay`) with innerHTML containing a `modal-box` div: heading "Delete doc?", paragraph "This will permanently delete **{title}** from the repository." (use `escapeHtml(title)` in the `<strong>` tag), action buttons (Delete `id="confirm-delete-btn"` class `btn-action btn-danger`, Cancel `id="cancel-delete-btn"` class `btn-action btn-secondary`), and an error paragraph (`id="modal-error"`, class `form-error`, hidden).
- Append overlay to `document.body`.
- Wire Cancel: `overlay.remove();`
- Wire click-outside: if `e.target === overlay`, remove overlay.
- Wire Confirm Delete:
  1. Disable button, change text to "Deleting..."
  2. Update index FIRST: `const indexFile = await getFile('data/docs/index.json');` parse, filter out the slug, `await writeFile('data/docs/index.json', JSON.stringify(updated, null, 2), 'docs: remove ' + slug);`
  3. Then delete the file: `await deleteFile('data/docs/' + slug + '.md', 'docs: delete ' + slug);`
  4. Remove overlay.
  5. Refresh sidebar: `await populateDocList();`
  6. Navigate: `window.location.hash = '#/docs';`
  7. On error: show modal-error, re-enable button.

Also update the router's `renderCreateView` stub from Plan 01 to call the real function.
  </action>
  <verify>Open the site while authenticated and verify:
1. "+" button appears next to "Docs" in sidebar only when authenticated
2. Clicking "+" navigates to `#/docs/new` and shows the create form
3. Slug validation rejects invalid characters and shows inline error
4. Creating a doc with valid inputs writes both files (check Network tab for two PUTs)
5. After creation, the new doc appears in the sidebar and the view navigates to it
6. Clicking delete (X) on a sidebar doc shows the confirmation modal naming the doc title
7. Confirming delete removes the doc from sidebar and navigates to `#/docs`
8. Canceling delete or clicking outside the modal dismisses it
9. Duplicate slug shows "A doc with this slug already exists" error
  </verify>
  <done>Create form validates and writes new doc + index.json via GitHub API, delete modal confirms and removes doc + updates index.json, sidebar refreshes after both operations, "New Doc" button is auth-gated in sidebar</done>
</task>

<task type="auto">
  <name>Task 2: Add create form, modal overlay, and form field CSS styles</name>
  <files>style.css</files>
  <action>
Add CSS sections in style.css:

**Nav section header (for New Doc button alignment):**
```css
.nav-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
```

**Create view layout:**
```css
.create-view {
  max-width: 720px;
}

.create-view h1 {
  margin-bottom: 1.25rem;
  font-size: 1.5rem;
}
```

**Form fields:**
```css
.form-field {
  margin-bottom: 1rem;
}

.form-field label {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  margin-bottom: 0.35rem;
  color: var(--text-secondary);
}

.form-input {
  width: 100%;
  padding: 8px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.9rem;
  font-family: inherit;
  outline: none;
}

.form-input:focus {
  border-color: var(--accent);
}

.field-hint {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-top: 0.25rem;
}

.form-error {
  color: #c0392b;
  font-size: 0.85rem;
  margin-top: 0.5rem;
}

.form-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1.25rem;
}
```

**Modal overlay:**
```css
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
}

.modal-box {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1.5rem;
  max-width: 420px;
  width: 90%;
}

.modal-box h2 {
  margin-bottom: 0.75rem;
  font-size: 1.125rem;
}

.modal-box p {
  color: var(--text-secondary);
  font-size: 0.9rem;
  line-height: 1.5;
}

.modal-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}
```

**Danger button:**
```css
.btn-danger {
  background: #c0392b;
  color: #fff;
}

.btn-danger:hover {
  background: #a93226;
}
```
  </action>
  <verify>Open the site and verify:
1. Create form fields are properly styled with labels, inputs, and hints
2. Modal overlay covers full viewport with semi-transparent black background
3. Modal box is centered, styled with dark theme variables, and has proper padding
4. Danger (delete) button is red with darker hover state
5. Form actions and modal actions are flex rows with proper spacing
6. Nav section header aligns "Docs" title and "+" button horizontally
  </verify>
  <done>All create form, modal, and form field CSS styles render correctly with dark theme variables — form inputs match existing site style, modal overlay is properly layered, danger button is visually distinct</done>
</task>

</tasks>

<verification>
1. Click "+" in sidebar → create form appears with slug, title, body fields
2. Enter invalid slug (uppercase, spaces) → inline error shown
3. Enter valid slug, title, body → both files written, doc appears in sidebar, navigated to new doc
4. Try duplicate slug → "already exists" error shown
5. Click delete (X) on sidebar doc → modal shows doc title
6. Confirm delete → doc removed from sidebar, index.json updated, file deleted
7. Cancel delete → modal dismissed, no changes
8. All operations only visible/functional when authenticated
</verification>

<success_criteria>
- renderCreateView validates slug format and uniqueness before writing
- Create flow writes .md file first, then updates index.json, then refreshes sidebar
- showDeleteModal displays confirmation with doc title and executes delete flow on confirm
- Delete flow updates index.json first, then deletes .md file, then refreshes sidebar
- "New Doc" button in sidebar is auth-gated and navigates to #/docs/new
- All form/modal CSS uses dark theme variables consistently
</success_criteria>

<output>
After completion, create `.planning/phases/10-site-doc-crud/10-02-SUMMARY.md`
</output>
