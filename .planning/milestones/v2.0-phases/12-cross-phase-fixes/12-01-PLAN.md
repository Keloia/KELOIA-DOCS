---
phase: 12-cross-phase-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app.js
  - index.html
  - data/docs/index.json
autonomous: true
requirements:
  - INT-01
  - INT-02
  - INT-03
  - INT-04
  - FLOW-01
  - FLOW-02

must_haves:
  truths:
    - "After creating a doc, searching for its title returns a result without page refresh"
    - "After editing a doc, searching for the new content returns a result without page refresh"
    - "After deleting a doc, searching for its title returns no result without page refresh"
    - "Navigating to #/docs/any-slug/edit while unauthenticated redirects to the doc view"
    - "github.js loads before app.js — no ReferenceError risk on eager invocation"
    - "MCP tool keloia_search_docs can find content in mcp-guide.md"
  artifacts:
    - path: "app.js"
      provides: "Search index invalidation after CRUD + edit route auth guard"
      contains: "searchIndex = null"
    - path: "index.html"
      provides: "Correct script load order + no duplicate mcp-guide sidebar entry"
      contains: "github.js"
    - path: "data/docs/index.json"
      provides: "mcp-guide as first-class doc in index"
      contains: "mcp-guide"
  key_links:
    - from: "app.js renderCreateView"
      to: "buildSearchIndex()"
      via: "searchIndex = null then buildSearchIndex() after writeFile success"
      pattern: "searchIndex\\s*=\\s*null"
    - from: "app.js router()"
      to: "getAuthToken()"
      via: "auth guard before renderEditView dispatch"
      pattern: "getAuthToken.*edit"
    - from: "data/docs/index.json"
      to: "mcp-server/src/tools/docs.ts"
      via: "keloia_search_docs reads index.json to enumerate docs"
      pattern: "mcp-guide"
---

<objective>
Close all cross-phase integration gaps identified by the v2.0 milestone audit: search index invalidation after CRUD operations, edit route auth guard, script load order fix, and mcp-guide accessibility to MCP tools.

Purpose: These four gaps represent wiring issues between phases 6-11 where features work individually but break when combined (stale search after doc writes, unprotected edit route via direct URL, dependency-inverted script loading, and mcp-guide invisible to MCP search).

Output: Patched app.js, index.html, and data/docs/index.json with all six gap IDs resolved.
</objective>

<execution_context>
@/Users/enjat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enjat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-cross-phase-fixes/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Search index invalidation + edit route auth guard in app.js</name>
  <files>app.js</files>
  <action>
Apply three changes to app.js:

**INT-01 — Search index invalidation (3 locations):**

In each CRUD success path, add `searchIndex = null; buildSearchIndex();` immediately AFTER the successful `await writeFile(...)` or `await deleteFile(...)` call and BEFORE any navigation or sidebar refresh. The `buildSearchIndex()` call is non-blocking (async, no await needed) — it starts the rebuild in the background and handles pending search input automatically via its existing "if user typed while building" logic.

1. **renderCreateView success path** — After `await writeFile('data/docs/index.json', ...)` succeeds (the second writeFile), add:
   ```javascript
   searchIndex = null;
   buildSearchIndex();
   ```
   Before the `await populateDocList()` line.

2. **renderEditView save handler success path** — After `await writeFile('data/docs/' + slug + '.md', ...)` succeeds, add:
   ```javascript
   searchIndex = null;
   buildSearchIndex();
   ```
   Before the `window.location.hash = '#/docs/' + slug;` line.

3. **showDeleteModal confirm handler success path** — After `await deleteFile(...)` succeeds (the last write operation in the try block), add:
   ```javascript
   searchIndex = null;
   buildSearchIndex();
   ```
   Before the `overlay.remove()` line.

**INT-02 — Edit route auth guard (1 location):**

In the `router()` function, find the `else if (subview === 'edit' && param)` branch. Add an auth check at the top of that branch:
```javascript
} else if (subview === 'edit' && param) {
  if (!getAuthToken()) {
    window.location.hash = '#/docs/' + param;
    return;  // stop current router invocation — hashchange re-enters router
  }
  await renderEditView(param);
  updateActiveNav('docs', param);
  break;
}
```

Use `return` (not `break`) after setting the redirect hash — `return` prevents the current router invocation from continuing. The auth race condition (initAuth non-blocking) is a known acceptable edge case per research.

**INT-04b — Remove hardcoded mcp-guide from buildSearchIndex:**

In `buildSearchIndex()`, find the line that spreads mcp-guide into the docs array:
```javascript
const docs = [...data.docs, { slug: 'mcp-guide', title: 'MCP Setup Guide' }];
```
Replace with:
```javascript
const docs = data.docs;
```
This prevents a MiniSearch duplicate-id error now that mcp-guide will be in index.json (Task 2).
  </action>
  <verify>
1. Search for `searchIndex = null` in app.js — should appear in 3 CRUD success paths (create, edit save, delete confirm).
2. Search for `getAuthToken()` in the router function — should appear in the edit branch guard.
3. Confirm no hardcoded mcp-guide spread in buildSearchIndex — `const docs = data.docs;` with no spread.
  </verify>
  <done>
Three CRUD success paths reset searchIndex and trigger rebuild. Edit route redirects unauthenticated users to doc view. buildSearchIndex uses index.json as sole doc source.
  </done>
</task>

<task type="auto">
  <name>Task 2: Script order fix, mcp-guide in index.json, sidebar cleanup in index.html</name>
  <files>index.html, data/docs/index.json</files>
  <action>
Apply three changes across two files:

**INT-03 — Script load order in index.html:**

Find the two `<script defer>` tags near the bottom of `<body>`:
```html
<script src="app.js" defer></script>
<script src="github.js" defer></script>
```
Swap their order:
```html
<script src="github.js" defer></script>
<script src="app.js" defer></script>
```

Both scripts use `defer` so they execute in document order after HTML parsing. Swapping ensures `github.js` globals (getFile, writeFile, deleteFile) are defined before `app.js` runs. This is safe because `getAuthToken()` (defined in app.js, called lazily by github.js inside `authHeaders()`) is only invoked at user interaction time, not at script evaluation time.

**INT-04a — Add mcp-guide to data/docs/index.json:**

Add the mcp-guide entry to the docs array:
```json
{
  "schemaVersion": 1,
  "docs": [
    { "slug": "architecture", "title": "Architecture" },
    { "slug": "value-proposition", "title": "Value Proposition" },
    { "slug": "mcp-guide", "title": "MCP Setup Guide" }
  ]
}
```

This makes mcp-guide discoverable by `keloia_search_docs` (which reads index.json to enumerate docs) and by the site search (buildSearchIndex fetches index.json). The hardcoded spread in buildSearchIndex was already removed in Task 1.

**INT-04c — Remove hardcoded Resources section from index.html:**

Find and remove the entire Resources nav section in the sidebar:
```html
<section class="nav-section">
  <h3 class="nav-section-title">Resources</h3>
  <ul class="nav-list">
    <li><a href="#/docs/mcp-guide" data-view="docs" data-slug="mcp-guide">MCP Setup Guide</a></li>
  </ul>
</section>
```

With mcp-guide now in index.json, `populateDocList()` will render it in the Docs list naturally. The Resources section (which only contained mcp-guide) is no longer needed. Nav highlighting continues to work because `updateActiveNav('docs', 'mcp-guide')` finds links by `href="#/docs/mcp-guide"`, and `populateDocList()` generates links with that same href format.
  </action>
  <verify>
1. In index.html, confirm `github.js` script tag appears BEFORE `app.js` script tag.
2. In data/docs/index.json, confirm mcp-guide entry is present with slug "mcp-guide" and title "MCP Setup Guide".
3. In index.html, confirm no Resources nav section exists (no "Resources" h3 in sidebar).
4. Run `cd mcp-server && npm run build` to confirm MCP server builds (no source changes, but validates no regression).
  </verify>
  <done>
github.js loads before app.js eliminating dependency inversion. mcp-guide is in index.json as a first-class doc visible to both MCP tools and site search. Resources sidebar section removed (no duplicate entry).
  </done>
</task>

</tasks>

<verification>
All six gap IDs resolved:
- INT-01: `searchIndex = null; buildSearchIndex()` in 3 CRUD success paths (create, edit, delete)
- INT-02: `if (!getAuthToken())` guard in router edit branch redirects to doc view
- INT-03: `github.js` defer tag before `app.js` defer tag in index.html
- INT-04: mcp-guide in index.json + hardcoded spread removed from buildSearchIndex + Resources section removed from sidebar
- FLOW-01: Resolved by INT-01 (create → search works)
- FLOW-02: Resolved by INT-01 (edit → search works)
</verification>

<success_criteria>
1. After creating a doc via the site UI, searching for its title returns results without page refresh
2. After editing a doc, searching for the edited content returns results without page refresh
3. After deleting a doc, searching for its title returns no results without page refresh
4. Navigating to #/docs/any-slug/edit while unauthenticated redirects to #/docs/any-slug
5. No console errors about undefined functions from script load order
6. `keloia_search_docs` with query "MCP Setup Guide" returns mcp-guide content
7. No duplicate mcp-guide entries in sidebar or search results
</success_criteria>

<output>
After completion, create `.planning/phases/12-cross-phase-fixes/12-01-SUMMARY.md`
</output>
