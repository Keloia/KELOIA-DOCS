---
phase: 05-write-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp-server/src/tools/write.ts
  - mcp-server/src/server.ts
autonomous: true
requirements:
  - WRITE-01
  - WRITE-02
  - WRITE-03
  - WRITE-04

must_haves:
  truths:
    - "keloia_add_task creates a task file and updates the kanban index"
    - "keloia_move_task changes a task's column field atomically"
    - "keloia_update_progress merges only provided fields into a milestone file"
    - "All writes use temp file + renameSync atomic pattern"
    - "Invalid inputs return isError: true with clear messages naming valid options"
  artifacts:
    - path: "mcp-server/src/tools/write.ts"
      provides: "Three write tools: keloia_add_task, keloia_move_task, keloia_update_progress"
      exports: ["registerWriteTools"]
    - path: "mcp-server/src/server.ts"
      provides: "Wires registerWriteTools after registerReadTools"
      contains: "registerWriteTools"
  key_links:
    - from: "mcp-server/src/tools/write.ts"
      to: "mcp-server/src/paths.ts"
      via: "import KANBAN_DIR, PROGRESS_DIR"
      pattern: "import.*KANBAN_DIR.*PROGRESS_DIR.*paths"
    - from: "mcp-server/src/server.ts"
      to: "mcp-server/src/tools/write.ts"
      via: "import registerWriteTools, call it"
      pattern: "registerWriteTools\\(server\\)"
---

<objective>
Implement three MCP write tools (keloia_add_task, keloia_move_task, keloia_update_progress) in a new write.ts module and wire them into server.ts.

Purpose: Enables Claude Code to mutate kanban and progress data through validated, atomic file writes.
Output: mcp-server/src/tools/write.ts with three tools, updated server.ts wiring.
</objective>

<execution_context>
@/Users/enjat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enjat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-write-tools/05-RESEARCH.md
@mcp-server/src/tools/read.ts
@mcp-server/src/server.ts
@mcp-server/src/paths.ts
@data/kanban/index.json
@data/kanban/task-001.json
@data/progress/index.json
@data/progress/milestone-01.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create write.ts with three write tools and atomic write helper</name>
  <files>mcp-server/src/tools/write.ts</files>
  <action>
Create `mcp-server/src/tools/write.ts` exporting `registerWriteTools(server: McpServer): void`.

Follow the exact same patterns as `read.ts` (same imports shape, same `type: "text" as const`, same try/catch isError returns, same pretty-printed JSON responses).

Include these module-level helpers:

1. `atomicWriteJson(targetPath: string, data: unknown): void` — writes `JSON.stringify(data, null, 2)` to `${targetPath}.tmp`, then `renameSync(tmp, targetPath)`. Uses `writeFileSync` and `renameSync` from `node:fs`.

2. `nextTaskId(existingIds: string[]): string` — parses numeric suffix from existing IDs, returns `"task-" + String(max + 1).padStart(3, "0")`. Returns `"task-001"` if array is empty.

3. `const VALID_COLUMNS = ["Backlog", "In Progress", "Done"] as const;` — matches `data/kanban/index.json` columns.

4. `const VALID_STATUSES = ["pending", "in-progress", "done"] as const;` — matches milestone status values.

Implement three tools via `server.registerTool()` (NOT the deprecated `server.tool()`):

**keloia_add_task** (WRITE-01):
- Description: "Creates a new task on the keloia kanban board. Writes a new task file and updates the kanban index. Returns the created task object with its generated ID. Provide a title; column defaults to Backlog."
- inputSchema: `title` (z.string().min(1)), `column` (z.enum(VALID_COLUMNS).default("Backlog")), `description` (z.string().optional()), `assignee` (z.string().optional())
- Handler: Read kanban index, generate next ID via `nextTaskId`, build task object `{ id, title, column, description: description ?? null, assignee: assignee ?? null }`, atomicWriteJson the task file FIRST, then atomicWriteJson the updated index with the new ID appended to tasks array. Return the created task object as pretty-printed JSON.
- Error: try/catch wrapping the whole handler, return isError with message.

**keloia_move_task** (WRITE-02):
- Description: "Moves an existing keloia kanban task to a different column. Updates the task file atomically. Returns the updated task object."
- inputSchema: `id` (z.string()), `column` (z.enum(VALID_COLUMNS))
- Handler: Read kanban index, validate `id` exists in `index.tasks` — if not, return `isError: true` with `Task not found: "{id}". Known tasks: {index.tasks.join(", ")}`. Read the task file, spread existing task, overwrite `column`, atomicWriteJson the task file. Return the updated task as pretty-printed JSON.
- Error: try/catch wrapping, return isError.

**keloia_update_progress** (WRITE-03):
- Description: "Updates fields on a keloia milestone. Merges only the provided fields into the existing milestone file atomically. Returns the updated milestone object."
- inputSchema: `id` (z.string()), `status` (z.enum(VALID_STATUSES).optional()), `tasksTotal` (z.number().int().min(0).optional()), `tasksCompleted` (z.number().int().min(0).optional()), `notes` (z.string().nullable().optional()) — note `nullable()` on notes because milestone notes can be `null`.
- Handler: Read progress index, validate `id` exists in `index.milestones` — if not, return `isError: true` with `Milestone not found: "{id}". Known: {index.milestones.join(", ")}`. Read the milestone file, start with `const updated = { ...existing }`, then apply each field ONLY if `!== undefined`. atomicWriteJson the milestone file. Return the updated milestone as pretty-printed JSON.
- Error: try/catch wrapping, return isError.

Import from `../paths.js` (not `../paths`). All TypeScript imports use `.js` extension per Node16 ESM.
  </action>
  <verify>Run `cd /Users/enjat/Github/keloia/keloia-docs/mcp-server && npx tsc --noEmit` — zero TypeScript errors.</verify>
  <done>write.ts exists with registerWriteTools exporting three tools. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Wire registerWriteTools into server.ts</name>
  <files>mcp-server/src/server.ts</files>
  <action>
Update `mcp-server/src/server.ts`:

1. Add import: `import { registerWriteTools } from "./tools/write.js";`
2. Call `registerWriteTools(server);` after the existing `registerReadTools(server);` line
3. Remove the `// Write tools registered in Phase 5` comment (it is now done)

Do NOT change anything else in server.ts — the McpServer constructor and registerReadTools call must remain exactly as they are.
  </action>
  <verify>Run `cd /Users/enjat/Github/keloia/keloia-docs/mcp-server && npx tsc --noEmit` — zero errors. Grep for `registerWriteTools` in server.ts confirms the import and call are present.</verify>
  <done>server.ts imports and calls registerWriteTools. TypeScript compiles with zero errors. Both read and write tools are wired.</done>
</task>

</tasks>

<verification>
1. `cd mcp-server && npx tsc --noEmit` passes with zero errors
2. `grep -c "registerTool" mcp-server/src/tools/write.ts` returns 3 (three tools registered)
3. `grep "registerWriteTools" mcp-server/src/server.ts` shows import and call
4. `grep "atomicWriteJson" mcp-server/src/tools/write.ts` confirms atomic write helper exists
5. `grep "renameSync" mcp-server/src/tools/write.ts` confirms POSIX atomic rename is used
6. `grep "console.log" mcp-server/src/tools/write.ts` returns zero results (no stdout pollution)
</verification>

<success_criteria>
- write.ts contains three tools (keloia_add_task, keloia_move_task, keloia_update_progress) all using registerTool
- All writes go through atomicWriteJson (temp file + renameSync)
- server.ts calls registerWriteTools(server) after registerReadTools(server)
- TypeScript compiles with zero errors
- No console.log anywhere in write.ts
</success_criteria>

<output>
After completion, create `.planning/phases/05-write-tools/05-01-SUMMARY.md`
</output>
