---
phase: 06-site-search-guide
plan: 02
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - app.js
autonomous: true
requirements:
  - SRCH-02
  - SRCH-03
  - SRCH-04

must_haves:
  truths:
    - "Typing in the search box shows results within the same keystroke cycle (debounced)"
    - "Each search result shows the doc title and a text snippet with matched content"
    - "Clicking a search result navigates to that doc"
    - "The search index builds on first focus of the search box, not on page load"
    - "Search results clear when navigating to a doc"
  artifacts:
    - path: "app.js"
      provides: "Search module: lazy index build, debounced input handler, result rendering, snippet extraction"
      contains: "buildSearchIndex"
  key_links:
    - from: "app.js"
      to: "MiniSearch global"
      via: "new MiniSearch() in buildSearchIndex"
      pattern: "new MiniSearch"
    - from: "app.js"
      to: "#search-input"
      via: "focus and input event listeners"
      pattern: "search-input.*addEventListener"
    - from: "app.js"
      to: "#search-results"
      via: "renderSearchResults populates the dropdown"
      pattern: "search-results"
    - from: "app.js"
      to: "data/docs/*.md"
      via: "fetch all doc markdown files during index build"
      pattern: "fetch.*data/docs/"
---

<objective>
Implement the search JavaScript logic in app.js: lazy MiniSearch index build on first focus, debounced input handler, snippet extraction, result rendering, and navigation clearing.

Purpose: Makes the search box functional (SRCH-02, SRCH-03, SRCH-04). This is the interactive behavior layer that brings the HTML/CSS from Plan 01 to life.
Output: Users can search doc content from the sidebar with live results, snippets, and click-to-navigate.
</objective>

<execution_context>
@/Users/enjat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enjat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-site-search-guide/6-RESEARCH.md
@.planning/phases/06-site-search-guide/06-01-SUMMARY.md
@app.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement search module in app.js</name>
  <files>app.js</files>
  <action>
Add a new section in `app.js` between the "Utility" section and the "Router" section. Title it "Site Search". Implement the following functions:

1. **Module-level state variables:**
   ```javascript
   let searchIndex = null;
   let indexBuilding = false;
   ```

2. **`debounce(fn, delay)` utility function:**
   - Standard setTimeout/clearTimeout pattern (3 lines)
   - Returns a wrapper function that clears previous timer and sets new one
   - Place this in the existing Utility section alongside `escapeHtml`

3. **`buildSearchIndex()` async function:**
   - Guard: if `searchIndex` or `indexBuilding` is truthy, return immediately
   - Set `indexBuilding = true`
   - Fetch `data/docs/index.json` to get the doc list
   - ALSO include `mcp-guide` manually (it is not in index.json to avoid duplicate nav). Create an additional entry: `{ slug: 'mcp-guide', title: 'MCP Setup Guide' }`
   - Fetch all doc markdown files in parallel via `Promise.all` — for each doc, fetch `data/docs/${slug}.md` and get the text
   - Create `new MiniSearch({ fields: ['title', 'text'], storeFields: ['title', 'slug', 'text'] })`
   - Each document needs a unique `id` field — use the slug as the id
   - Call `miniSearch.addAll(documents)`
   - Set `searchIndex = miniSearch`, `indexBuilding = false`
   - After index is ready, if the search input already has a value (user typed while indexing), trigger the search handler with that value

4. **`extractSnippet(text, query, windowSize = 120)` function:**
   - Split query into lowercase terms
   - Find first occurrence of any term in the lowercase text
   - If found, slice a window of `windowSize` characters centered around the match (start 40 chars before match)
   - Replace newlines with spaces in the snippet
   - Add ellipsis at start/end if truncated
   - If no match found, return first `windowSize` characters + ellipsis

5. **`renderSearchResults(results, query)` function:**
   - Get `#search-results` element
   - If no results or empty array: set `hidden = true`, clear innerHTML, return
   - Map each result to an `<li class="search-result-item">` containing:
     - `<a href="#/docs/${escapeHtml(r.slug)}">` wrapping:
       - `<span class="result-title">${escapeHtml(r.title)}</span>`
       - `<span class="result-snippet">${escapeHtml(extractSnippet(r.text, query))}</span>`
   - Set innerHTML and `hidden = false`

6. **`handleSearch` debounced function (150ms):**
   - Accepts the query string
   - If `!searchIndex` or `!query.trim()`: call `renderSearchResults([])` and return
   - Call `searchIndex.search(query, { prefix: true, boost: { title: 2 }, fuzzy: 0.2, limit: 5 })`
   - Pass results to `renderSearchResults(results, query)`

7. **Event listener setup in the Bootstrap section (inside `DOMContentLoaded`):**
   - Get `#search-input` element
   - Add `focus` listener with `{ once: true }` that calls `buildSearchIndex()`
   - Add `input` listener that calls `handleSearch(e.target.value)`
  </action>
  <verify>
  - `app.js` contains `buildSearchIndex`, `extractSnippet`, `renderSearchResults`, `handleSearch`, `debounce` functions
  - `app.js` has `new MiniSearch` call with `fields: ['title', 'text']` and `storeFields: ['title', 'slug', 'text']`
  - `app.js` has focus listener with `{ once: true }` on search-input
  - `app.js` has input listener with debounced handler on search-input
  - No syntax errors: open the site in browser, check console for errors
  </verify>
  <done>Search module fully implemented: lazy index build on first focus, debounced input handler, snippet extraction, result rendering with doc title and text snippet</done>
</task>

<task type="auto">
  <name>Task 2: Add search state clearing on navigation</name>
  <files>app.js</files>
  <action>
1. In the `router()` function, add search state clearing at the TOP of the function, before the `switch` statement:
   ```javascript
   // Clear search state on navigation
   const searchInput = document.getElementById('search-input');
   const searchResults = document.getElementById('search-results');
   if (searchInput) searchInput.value = '';
   if (searchResults) { searchResults.hidden = true; searchResults.innerHTML = ''; }
   ```
   This prevents the pitfall where search results persist after clicking a result to navigate.

2. In `renderSearchResults`, add a click handler on result links that clears the search:
   - After setting innerHTML, add click listeners to all `.search-result-item a` elements
   - Each click listener clears the search input value and hides the results container
   - This ensures immediate visual feedback even before hashchange fires

3. Add a `click` listener on the `document` to close the search results dropdown when clicking outside:
   - If the click target is not inside `.search-container`, hide the results and clear input
   - Add this in the Bootstrap section alongside the other search event listeners
  </action>
  <verify>
  - Search a term, click a result — search input clears and results hide
  - Search a term, click outside the search container — results hide
  - Navigate via sidebar links — search input is cleared
  - After clearing, the search box shows the placeholder text again
  </verify>
  <done>Search state clears on navigation (hashchange), on result click, and on click-outside — no stale search results visible after interaction</done>
</task>

</tasks>

<verification>
1. Open the site — search box is visible but no network requests for doc content yet (check Network tab)
2. Click/focus the search input — Network tab shows fetches for all doc markdown files (lazy build)
3. Type "arch" — results appear showing "Architecture" doc with a text snippet
4. Type "mcp" — results appear showing "MCP Setup Guide" with a snippet
5. Click a search result — navigates to that doc, search input clears, results hide
6. Search again, click outside the search area — results hide
7. Navigate via sidebar link while results are showing — results clear
8. Fast typing — no errors, results update smoothly with debounce
</verification>

<success_criteria>
- Search results appear live as user types (debounced at 150ms)
- Results show doc title and a text snippet containing the matched content
- Clicking a result navigates to the doc
- Search index builds lazily on first focus, not on page load
- Search state clears properly on all navigation paths
- No console errors during search interaction
</success_criteria>

<output>
After completion, create `.planning/phases/06-site-search-guide/06-02-SUMMARY.md`
</output>
