---
phase: 10-site-doc-crud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app.js, style.css]
autonomous: true
requirements: [CRUD-02, CRUD-03]

must_haves:
  truths:
    - "Authenticated user can click Edit on a doc in the sidebar and see a textarea pre-filled with the doc's markdown content"
    - "User can toggle between raw markdown editing and a rendered HTML preview without losing edits"
    - "User can save edits and be navigated to the updated doc view"
    - "Edit and delete icon buttons appear on each sidebar doc entry only when authenticated"
  artifacts:
    - path: "app.js"
      provides: "renderEditView, populateDocList edit/delete buttons, router extension for /docs/slug/edit"
      contains: "renderEditView"
    - path: "style.css"
      provides: "Edit view styles: textarea, toolbar, preview, sidebar action buttons"
      contains: "edit-textarea"
  key_links:
    - from: "app.js renderEditView"
      to: "fetch('data/docs/slug.md')"
      via: "fetch to load current markdown content"
      pattern: "fetch.*data/docs/"
    - from: "app.js save-btn click"
      to: "writeFile('data/docs/slug.md')"
      via: "GitHub API wrapper global"
      pattern: "writeFile\\("
    - from: "app.js preview-toggle-btn"
      to: "marked.parse + DOMPurify.sanitize"
      via: "preview rendering pipeline"
      pattern: "marked\\.parse"
    - from: "app.js router"
      to: "renderEditView"
      via: "hash route #/docs/slug/edit"
      pattern: "parts\\[3\\].*edit"
---

<objective>
Wire the edit view for docs: extend the router to handle `#/docs/slug/edit`, create `renderEditView(slug)` with textarea + save + preview toggle, and add per-doc edit/delete sidebar buttons in `populateDocList()`.

Purpose: CRUD-02 (edit existing doc) and CRUD-03 (preview toggle) are the core authoring experience — users must be able to modify docs directly from the site.

Output: Modified `app.js` with edit view logic and modified `style.css` with edit view styles.
</objective>

<execution_context>
@/Users/enjat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enjat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-site-doc-crud/10-RESEARCH.md
@.planning/phases/09-github-api-wrapper/09-01-SUMMARY.md
@.planning/phases/08-github-auth/08-01-SUMMARY.md
@app.js
@style.css
@index.html
@github.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend router and add renderEditView with preview toggle and sidebar action buttons</name>
  <files>app.js</files>
  <action>
Three changes to app.js:

**1. Extend the router to handle edit and create routes.**

In `router()`, after extracting `param = parts[2]`, add `const subview = parts[3] || null;`. In the `case 'docs':` block, add route branching BEFORE the existing `await renderDoc(param)`:

```
if (param === 'new') {
  await renderCreateView();   // Plan 02 will implement; for now just a stub: mainEl.innerHTML = '<p>Create view coming soon.</p>';
} else if (subview === 'edit' && param) {
  await renderEditView(param);
  updateActiveNav('docs', param);
  break;
}
```

Keep the existing `await renderDoc(param)` as the else fallback. The `renderCreateView` stub ensures the route doesn't break before Plan 02 implements it.

**2. Create `renderEditView(slug)` function.**

Add a new section in app.js titled `/* === Doc Edit View === */` before the Router section. Implementation:

- Fetch `data/docs/${slug}.md` via plain `fetch()` (read-only, no auth needed). If not ok, show "Document not found." and return.
- Set `mainEl.innerHTML` to an edit-view shell: a toolbar div with Save button (`id="save-btn"`, class `btn-action`), Preview button (`id="preview-toggle-btn"`, class `btn-action btn-secondary`), Cancel button (`id="cancel-btn"`, class `btn-action btn-secondary`); an empty textarea (`id="edit-textarea"`, class `edit-textarea`); a hidden div (`id="edit-preview"`, class `edit-preview`, attribute `hidden`).
- IMPORTANT: Set `document.getElementById('edit-textarea').value = markdown;` AFTER the innerHTML assignment — never set textarea content via innerHTML or template literal interpolation. The textarea body in the HTML template must be empty.
- Wire event listeners:
  - **Preview toggle:** Track `let previewing = false`. On click: if toggling to preview, run `marked.parse(textarea.value)` through `DOMPurify.sanitize(rawHtml, { USE_PROFILES: { html: true } })`, set `preview.innerHTML` to result, hide textarea (`textarea.hidden = true`), show preview (`preview.hidden = false`), change button text to "Edit". If toggling back, hide preview, show textarea, change button text to "Preview".
  - **Cancel:** `window.location.hash = '#/docs/' + slug;`
  - **Save:** Disable save button, change text to "Saving...", call `await writeFile('data/docs/' + slug + '.md', textarea.value, 'docs: update ' + slug)`. On success, navigate to `#/docs/${slug}`. On error, re-enable button, change text back to "Save", show an inline error paragraph below the toolbar.

**3. Modify `populateDocList()` to add edit/delete action buttons.**

Change the `<li>` template in `populateDocList()` to include per-doc action buttons:

```javascript
docList.innerHTML = data.docs.map(doc => `
  <li class="doc-list-item">
    <a href="#/docs/${doc.slug}" data-view="docs" data-slug="${doc.slug}">
      ${escapeHtml(doc.title)}
    </a>
    <span class="doc-actions auth-only">
      <button class="btn-icon" data-action="edit" data-slug="${doc.slug}" title="Edit">✏</button>
      <button class="btn-icon btn-danger-icon" data-action="delete" data-slug="${doc.slug}" data-title="${escapeHtml(doc.title)}" title="Delete">✕</button>
    </span>
  </li>
`).join('');
```

Add event delegation on `docList` for the action buttons:

```javascript
docList.addEventListener('click', e => {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;
  e.preventDefault();
  e.stopPropagation();
  if (btn.dataset.action === 'edit') {
    window.location.hash = '#/docs/' + btn.dataset.slug + '/edit';
  } else if (btn.dataset.action === 'delete') {
    showDeleteModal(btn.dataset.slug, btn.dataset.title);
  }
});
```

Add a stub for `showDeleteModal` (Plan 02 implements the real version): `function showDeleteModal(slug, title) { alert('Delete ' + title + '? (coming in next plan)'); }`
  </action>
  <verify>Open the site in a browser while authenticated. Verify:
1. Each doc in the sidebar has edit (pencil) and delete (X) buttons visible only when authenticated
2. Clicking the edit button navigates to `#/docs/slug/edit` and shows the edit textarea with the doc content
3. Clicking Preview renders the markdown as HTML; clicking Edit returns to the textarea with content preserved
4. Clicking Save calls writeFile (check browser console Network tab for PUT to GitHub API)
5. Clicking Cancel returns to the doc view
6. The edit/delete buttons are hidden when not authenticated (logout and verify)
  </verify>
  <done>Edit view renders with pre-filled textarea, preview toggle works without losing content, save writes via GitHub API and navigates back, sidebar shows auth-gated edit/delete buttons per doc</done>
</task>

<task type="auto">
  <name>Task 2: Add edit view and sidebar action button CSS styles</name>
  <files>style.css</files>
  <action>
Add a new section in style.css titled `/* === Doc Edit View === */` with these styles:

**Edit view layout:**
```css
.edit-view {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 4rem);
}
```

**Edit toolbar:**
```css
.edit-toolbar {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}
```

**Edit textarea:**
```css
.edit-textarea {
  flex: 1;
  width: 100%;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-primary);
  font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  font-size: 0.875rem;
  line-height: 1.6;
  padding: 1rem;
  resize: none;
  outline: none;
}

.edit-textarea:focus {
  border-color: var(--accent);
}
```

**Edit preview area:**
```css
.edit-preview {
  flex: 1;
  overflow-y: auto;
  padding: 0.5rem 0;
}
```

**Action buttons (shared):**
```css
.btn-action {
  padding: 6px 14px;
  border: none;
  border-radius: 4px;
  background: var(--accent);
  color: #fff;
  cursor: pointer;
  font-size: 0.85rem;
  font-family: inherit;
}

.btn-action:hover {
  opacity: 0.9;
}

.btn-action:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-secondary {
  background: var(--bg-card);
  color: var(--text-primary);
  border: 1px solid var(--border);
}
```

**Sidebar doc-list action buttons:**
```css
.doc-list-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.doc-list-item a {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.doc-actions {
  display: flex;
  gap: 2px;
  flex-shrink: 0;
  opacity: 0;
  transition: opacity 0.15s;
}

.doc-list-item:hover .doc-actions {
  opacity: 1;
}

.btn-icon {
  background: none;
  border: none;
  cursor: pointer;
  padding: 2px 4px;
  font-size: 0.75rem;
  color: var(--text-secondary);
  border-radius: 3px;
}

.btn-icon:hover {
  background: var(--bg-card);
  color: var(--text-primary);
}

.btn-danger-icon:hover {
  color: #c0392b;
}
```

**Inline error for save failures:**
```css
.edit-error {
  color: #c0392b;
  font-size: 0.85rem;
  margin-top: 0.5rem;
}
```

Ensure `.auth-only` CSS gating from Phase 8 applies to `.doc-actions.auth-only` — no additional rules needed since the existing `body.authenticated .auth-only { display: block; }` will handle it. BUT: `.doc-actions` uses `display: flex`, so add an override:
```css
body.authenticated .doc-actions.auth-only {
  display: flex;
}
```
  </action>
  <verify>Open the site and verify:
1. Edit view textarea fills available height with monospace font
2. Toolbar buttons have correct spacing and styling
3. Preview area renders with proper padding
4. Sidebar doc action buttons appear on hover (opacity transition)
5. Action buttons are properly aligned (flex row, right side)
6. When authenticated, doc-actions show as flex (not block) on hover
  </verify>
  <done>All edit view CSS styles render correctly — textarea fills viewport, toolbar buttons are styled, sidebar action buttons show on hover with proper flex layout, auth-gated display works</done>
</task>

</tasks>

<verification>
1. Navigate to `#/docs/architecture/edit` — edit view renders with textarea content
2. Toggle preview — HTML renders, toggle back — textarea content preserved
3. Save changes — writeFile called, navigated back to doc view with updated content
4. Sidebar shows edit/delete buttons per doc (hover to reveal) when authenticated
5. Sidebar hides edit/delete buttons when not authenticated
6. `#/docs/new` shows stub text (Plan 02 implements create view)
</verification>

<success_criteria>
- renderEditView displays a textarea with the doc's current markdown content
- Preview toggle renders markdown via marked.parse + DOMPurify.sanitize without losing the textarea value
- Save button calls writeFile and navigates to the doc on success
- Router handles #/docs/slug/edit and #/docs/new routes
- populateDocList renders auth-gated edit/delete buttons per doc
- All CSS styles applied correctly with dark theme variables
</success_criteria>

<output>
After completion, create `.planning/phases/10-site-doc-crud/10-01-SUMMARY.md`
</output>
